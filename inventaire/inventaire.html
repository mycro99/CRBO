<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire réserve - CS Oupeye ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #dc3545;
      --secondary-color: #6c757d;
      --bg-color: #f5f5f5;
      --text-color: red; /* Texte global en rouge */
      --border-radius: 6px;
      --box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    /* Conteneur principal */
    #pdfContent {
      max-width: 900px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      color: var(--primary-color);
    }
    h1 {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
      border: 1px solid var(--secondary-color);
      border-radius: var(--border-radius);
      overflow: visible;
      box-shadow: var(--box-shadow);
    }
    th, td {
      border: 1px solid var(--secondary-color);
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: var(--primary-color);
      color: #fff;
      font-weight: 500;
    }
    /* Les 4 premières colonnes du tableau en noir */
    .inventory-table tbody td:nth-child(1),
    .inventory-table tbody td:nth-child(2),
    .inventory-table tbody td:nth-child(3),
    .inventory-table tbody td:nth-child(4) {
      color: black;
    }
    .pdf-button {
      display: inline-block;
      padding: 8px 16px;
      font-size: 14px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      box-shadow: var(--box-shadow);
      margin: 0 10px;
    }
    .pdf-button:hover {
      background-color: #c82333;
    }
    /* Boutons de gestion de stock */
    .stock-button {
      font-size: 24px;
      width: 50px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      margin: 0 5px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      box-shadow: var(--box-shadow);
    }
    .stock-button:hover {
      background-color: #c82333;
    }
    /* Styles pour les modaux */
    #scannerModal, #recommandationModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
    }
    #scannerContent {
      position: relative;
      margin: 10% auto;
      width: 80%;
      max-width: 600px;
      background: #fff;
      padding: 20px;
      color: black;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    /* Modal recommandations */
    #recommandationModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
    }
    #recommandationContent {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      background: #fff;
      padding: 20px;
      color: black;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    .button-container {
      text-align: center;
      margin-top: 30px;
    }
    /* Lignes de catégorie */
    .category-header {
      background-color: #fff;
      color: black;
      cursor: pointer;
      font-weight: bold;
      border: 1px solid var(--secondary-color);
    }
    /* Panneau de contrôle */
    .control-panel {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .left-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .control-panel input[type="text"] {
      padding: 5px;
      border: 1px solid var(--secondary-color);
      border-radius: var(--border-radius);
    }
  </style>
</head>
<body>
  <div id="pdfContent">
    <h1>Inventaire réserve - CS Oupeye ©</h1>
    
    <!-- Panneau de contrôle -->
    <div class="control-panel">
      <div class="left-controls">
        <button class="pdf-button" onclick="expandAll()">Tout dérouler</button>
        <button class="pdf-button" onclick="collapseAll()">Replier</button>
        <input type="text" id="searchInput" placeholder="Recherche..." onkeyup="searchArticles()">
        <button class="pdf-button" onclick="showRecommendations()">À recommander</button>
      </div>
      <div class="right-controls">
        <button class="pdf-button" onclick="openScanner()">Scanner</button>
      </div>
    </div>
    
    <table class="inventory-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Photo</th>
          <th>Quantité en stock</th>
          <th>Quantité minimum</th>
          <th>Gestion</th>
        </tr>
      </thead>
      <tbody id="inventoryTable">
        <!-- Exemple d'articles -->
        <tr class="category-header" data-category="consommables" onclick="toggleCategory('consommables')">
          <td colspan="5">Consommables <span id="toggle-consommables" style="float:right;">[+]</span></td>
        </tr>
        <tr class="article-row consommables" data-id="consommables-1" style="display: none;">
          <td>Accu‑check</td>
          <td><img src="images/Accu-check.jpg" alt="Photo Accu‑check" width="80"></td>
          <td id="stock-consommables-1">0</td>
          <td>2</td>
          <td>
            <button class="stock-button" onclick="updateStock('consommables-1', 1)">+</button>
            <button class="stock-button" onclick="updateStock('consommables-1', -1)">-</button>
          </td>
        </tr>
        <!-- ... (Le reste de vos lignes d'articles) ... -->
      </tbody>
    </table>
    
    <!-- Bouton Générer PDF -->
    <div class="button-container">
      <button class="pdf-button" onclick="generatePDF()">Générer le PDF</button>
    </div>
    
    <!-- Modal pour le scanner -->
    <div id="scannerModal">
      <div id="scannerContent">
        <h2>Scanner le code-barres</h2>
        <video id="video" width="100%" autoplay></video>
        <br>
        <button class="pdf-button" onclick="closeScanner()">Fermer</button>
      </div>
    </div>
    
    <!-- Modal pour les recommandations -->
    <div id="recommandationModal">
      <div id="recommandationContent">
        <h2>Articles à recommander</h2>
        <div id="recommendationList"></div>
        <br>
        <button class="pdf-button" onclick="generatePDFRecommendations()">Générer le PDF</button>
        <button class="pdf-button" onclick="closeRecommendations()">Fermer</button>
      </div>
    </div>
  </div>
  
  <!-- Inclusion de jsPDF et html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- Fonctions d'interface -->
  <script>
    // Mise à jour de la quantité en stock (fonction locale)
    function updateStock(articleId, change) {
      var stockElem = document.getElementById('stock-' + articleId);
      var currentStock = parseInt(stockElem.textContent);
      currentStock += change;
      if (currentStock < 0) currentStock = 0;
      stockElem.textContent = currentStock;
    }
    window.updateStock = updateStock;
    
    // Bascule l'affichage d'une catégorie
    function toggleCategory(category) {
      var rows = document.getElementsByClassName(category);
      var toggleSpan = document.getElementById("toggle-" + category);
      for (var i = 0; i < rows.length; i++) {
        rows[i].style.display = (rows[i].style.display === "none") ? "" : "none";
      }
      toggleSpan.textContent = (toggleSpan.textContent === "[+]") ? "[-]" : "[+]";
    }
    window.toggleCategory = toggleCategory;
    
    // Étend toutes les catégories
    function expandAll() {
      var articleRows = document.querySelectorAll(".article-row");
      articleRows.forEach(function(row) {
        row.style.display = "";
      });
      var toggleSpans = document.querySelectorAll('[id^="toggle-"]');
      toggleSpans.forEach(function(span) {
        span.textContent = "[-]";
      });
    }
    window.expandAll = expandAll;
    
    // Replie toutes les catégories
    function collapseAll() {
      var articleRows = document.querySelectorAll(".article-row");
      articleRows.forEach(function(row) {
        row.style.display = "none";
      });
      var toggleSpans = document.querySelectorAll('[id^="toggle-"]');
      toggleSpans.forEach(function(span) {
        span.textContent = "[+]";
      });
    }
    window.collapseAll = collapseAll;
    
    // Filtre les articles selon le texte recherché
    function searchArticles() {
      var filter = document.getElementById("searchInput").value.toUpperCase();
      var articleRows = document.querySelectorAll(".article-row");
      articleRows.forEach(function(row) {
        var cell = row.cells[0];
        if (cell) {
          var txtValue = cell.textContent || cell.innerText;
          row.style.display = (txtValue.toUpperCase().indexOf(filter) > -1) ? "" : "none";
        }
      });
      var categoryHeaders = document.querySelectorAll(".category-header");
      categoryHeaders.forEach(function(header) {
        var category = header.getAttribute("data-category");
        var rows = document.querySelectorAll(".article-row." + category);
        var anyVisible = false;
        rows.forEach(function(row) {
          if (row.style.display !== "none") {
            anyVisible = true;
          }
        });
        header.style.display = anyVisible ? "" : "none";
      });
    }
    window.searchArticles = searchArticles;
    
    // Affiche le popup des articles à recommander
    function showRecommendations() {
      var articleRows = document.querySelectorAll(".article-row");
      var recommendations = [];
      articleRows.forEach(function(row) {
        var cells = row.getElementsByTagName("td");
        if(cells.length >= 4) {
          var nom = cells[0].innerText;
          var stock = parseInt(cells[2].innerText);
          var min = parseInt(cells[3].innerText);
          if(stock <= min) {
            recommendations.push(nom + " (Stock: " + stock + " / Min: " + min + ")");
          }
        }
      });
      var recommendationList = document.getElementById("recommendationList");
      if(recommendations.length === 0) {
        recommendationList.innerHTML = "<p>Aucun article à recommander.</p>";
      } else {
        var htmlList = "<ul>";
        recommendations.forEach(function(item) {
          htmlList += "<li>" + item + "</li>";
        });
        htmlList += "</ul>";
        recommendationList.innerHTML = htmlList;
      }
      document.getElementById("recommandationModal").style.display = "block";
    }
    window.showRecommendations = showRecommendations;
    
    function closeRecommendations() {
      document.getElementById("recommandationModal").style.display = "none";
    }
    window.closeRecommendations = closeRecommendations;
    
    // Ferme le modal en cliquant à côté du contenu
    document.getElementById("recommandationModal").addEventListener("click", function(e) {
      if(e.target === this) {
        closeRecommendations();
      }
    });
    
    // Gestion du scanner
    function openScanner() {
      window.location.href = "scanner.html";
    }
    window.openScanner = openScanner;
    
    // Génère un PDF de l'intégralité du contenu
    function generatePDF() {
      const element = document.getElementById('pdfContent');
      html2canvas(element, { useCORS: true, scale: 1, allowTaint: true }).then(canvas => {
        const imgData = canvas.toDataURL("image/jpeg", 0.7);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        pdf.save("inventaire_reserve.pdf");
      });
    }
    window.generatePDF = generatePDF;
    
    // Génère un PDF de la pop-up "À recommander"
    function generatePDFRecommendations() {
      const element = document.getElementById('recommandationContent');
      const originalMaxHeight = element.style.maxHeight;
      const originalOverflowY = element.style.overflowY;
      element.style.maxHeight = 'none';
      element.style.overflowY = 'visible';
      html2canvas(element, { useCORS: true, scale: 2 }).then(canvas => {
        element.style.maxHeight = originalMaxHeight;
        element.style.overflowY = originalOverflowY;
        const imgData = canvas.toDataURL("image/jpeg", 1.0);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        pdf.save("articles_a_recommander.pdf");
      });
    }
    window.generatePDFRecommendations = generatePDFRecommendations;
  </script>
  
  <!-- Module Firebase -->
  <script type="module">
    // Importation des modules Firebase nécessaires
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-auth.js";

    // Votre configuration Firebase (personnalisez les valeurs)
    const firebaseConfig = {
      apiKey: "AIzaSyBa95NS-_TApkErWgkfhTzRhOyKss5W2aU",
      authDomain: "listing-44b2b.firebaseapp.com",
      projectId: "listing-44b2b",
      storageBucket: "listing-44b2b.firebasestorage.app",
      messagingSenderId: "310030019842",
      appId: "1:310030019842:web:c8a50b61f3dfbcb867e61b",
      measurementId: "G-419VVR3NHE"
    };


    // Initialisation de Firebase, Analytics, Firestore et Auth
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth();

    // Vérifie si l'utilisateur est authentifié et charge les données Firestore
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("Utilisateur authentifié :", user.email);
        loadInventoryFromFirestore();
      } else {
        console.log("Aucun utilisateur authentifié, redirection vers index.");
        window.location.href = "index.html";
      }
    });

function loadInventoryFromFirestoreModule() {
  const invCol = collection(dbModule, "inventory");
  onSnapshot(invCol, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === "modified") {
        const data = change.doc.data();
        const stockElem = document.getElementById("stock-" + data.id);
        if (stockElem) {
          stockElem.innerText = data.stock;
        }
      }
    });
  });
}

function updateStockFirestoreModule(productId, change) {
  const productRef = doc(dbModule, "inventory", productId);
  getDoc(productRef)
    .then((docSnap) => {
      if (docSnap.exists()) {
        let newStock = docSnap.data().stock + change;
        if (newStock < 0) newStock = 0;
        updateDoc(productRef, { stock: newStock });
      }
    })
    .catch((error) => {
      console.error("Erreur lors de la mise à jour du stock: ", error);
    });
}

// Exposez ces fonctions globalement si besoin
window.loadInventoryFromFirestoreModule = loadInventoryFromFirestoreModule;
window.updateStockFirestoreModule = updateStockFirestoreModule;

  </script>
</body>
</html>
